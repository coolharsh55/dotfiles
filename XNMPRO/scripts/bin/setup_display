#!/usr/bin/env bash
# Author: Harshvardhan Pandit
# Email: me@harshp.com
# License: MIT

# Script to automatically setup secondary monitors
# Uses xrandr and env variables to determine monitor and positioning
# Checks if display is connected using grep to find non-primary output
# Gets positioning using env variable MONITOR_POSITION
# Arguments:
#   default: does nothing
#   off: switches off secondary display
#   on: switches on secondary display
# Get primary display
DISPLAY_PRIMARY=$(xrandr --query | grep "eDP1" | grep -oP "^[\w-]+ ")
if [[ -z $DISPLAY_PRIMARY ]]
then
    echo "ERROR: Primary Monitor eDP1 cannot be detected"
    exit 1;
fi
# Get secondary display
DISPLAY_SECONDARY=$(xrandr --query | grep "\bconnected" | grep -v "$DISPLAY_PRIMARY" | grep -oP "^[\w-]+ ")
# Get monitor position from env
source ~/.env
#source ~/.config/monitors

# If no secondary display is connected, exit gracefully
exit_if_not_secondary_display() {
    if [ -z "$DISPLAY_SECONDARY" ]
    then
        exit 0;
    fi
}
exit_if_not_secondary_display

# Primary display only
display_only_primary() {
    eval "xrandr --output $DISPLAY_PRIMARY --auto --primary --output $DISPLAY_SECONDARY --off"
}
# Secondary display only
display_only_secondary() {
    eval "xrandr --output $DISPLAY_PRIMARY --off --output $DISPLAY_SECONDARY --auto --primary"
}
# Dual display, primary is laptop display
display_dual_primary_inbuilt() {
    eval "xrandr --output $DISPLAY_PRIMARY --auto --primary --output $DISPLAY_SECONDARY --auto --$MONITOR_POSITION $DISPLAY_PRIMARY"
}
# Dual display, primary is external display
display_dual_primary_external() {
    eval "xrandr --output $DISPLAY_PRIMARY --auto --output $DISPLAY_SECONDARY --auto --primary --$MONITOR_POSITION $DISPLAY_PRIMARY"
}

# switch on secondary display
switch_on() {
    display_dual_primary_inbuilt
}
# switch off secondary display
switch_off() {
    eval "xrandr --output ${DISPLAY_SECONDARY} --off --output $DISPLAY_PRIMARY --primary --auto"
}

# Handle arguments
while test $# -gt 0; do
    case "$1" in
        -h|--help)
            echo "xrandr display script"
            echo "  default: check for secondary display, if exists, activate;"
            echo "  -off: switches off secondary display"
            echo "  -on: switches on secondary display"
            echo "  -h: shows this message"
            ;;
        -n|--on)
            switch_on
            ;;
        -f|--off)
            switch_off
            ;;
        -a|--auto)
            if [ -z "$DISPLAY_SECONDARY" ]
            then
                switch_off
            else
                switch_on
            fi
            ;;
        -p|--primary-only)
            display_only_primary
            ;;
        -s|--secondary-only)
            display_only_secondary
            ;;
        *)
            if [ -z "$DISPLAY_SECONDARY" ]
            then
                switch_off
            else
                switch_on
            fi
            ;;
    esac
    break;
done
