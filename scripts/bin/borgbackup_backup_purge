#!/bin/bash
# Get backup disk information from user repo
source /home/harsh/.env
echo "Backup disk declared as ${BACKUPDISK}"
# Generate repository path from backup disk and hostname
REPOSITORY="/media/harsh/${BACKUPDISK}/backups/${HOSTNAME}"
echo "Repository at ${REPOSITORY}"
# check path is valid, abort if not
if [ ! -d $REPOSITORY ]; then
    echo ERROR: BACKUP FOLDER DOES NOT EXIST. DISK MAY NOT BE MOUNTED
    exit 1;
fi
# start backup
echo "creating borg backup..."
# set passphrase variable
source /home/harsh/.private/borg/${HOSTNAME}/passphrase
export BORG_PASSPHRASE=$PASSPHRASE
# create backup
borg create -v -s -p \
    $REPOSITORY::'{hostname}--{now:%Y-%m-%d-%H-%M}' \
    /home/harsh \
    --exclude '/home/harsh/.cache' \
    --exclude '/home/harsh/Music' \
    --exclude-caches
echo "finished backup."
# prune backups
echo "starting prune"
borg prune -v --list $REPOSITORY \
    --prefix '{hostname}--' \
    --keep-daily=7 \
    --keep-weekly=4 \
    --keep-month=6
# exit
echo "DONE"
exit 0
